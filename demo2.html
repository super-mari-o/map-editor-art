<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Devast.io MAP-EDITOR Assets DEMO</title>
		<meta name="description" content="DEMO DEMO DEMO" />
	</head>
	<body>
		<h1>Devast.io MAP-EDITOR Assets DEMO</h1>
		<dl id="demo_holder"></dl>
	</body>
	<script
		src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
		integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8="
		crossorigin="anonymous"
	></script>
	<script defer>
		$(demo_holder).empty();
		(async () => {
			const res = await fetch(
				'https://super-mari-o.github.io/map-editor-art/data/map-editor.yml',
			);
			const str = await res.text();
			const ymlArray = str
				.replaceAll(
					'https://devast.io/img/',
					'https://devasio.github.io/Devast/img/',
				)
				.trim()
				.split('\n')
				.map((v) => v.split(': '));
			for (const [ymlKey, imgUrl] of ymlArray) {
				$('<dt>').appendTo(demo_holder).text(ymlKey);
				const dd = $('<dd>').appendTo(demo_holder);
				const response = await fetch(imgUrl);
				const img = Object.assign(new Image(), {
					src: imgUrl,
					alt: ymlKey,
					crossOrigin: 'anonymous',
					onload: (elm) => {
						const canvas = document.createElement('canvas');
						const ctx = canvas.getContext('2d');
						canvas.width = img.width;
						canvas.height = img.height;
						ctx.drawImage(img, 0, 0);
						const imageData = ctx.getImageData(
							0,
							0,
							canvas.width,
							canvas.height,
						);
						const pixels = imageData.data;
						let minX = canvas.width,
							maxX = 0;
						let minY = canvas.height,
							maxY = 0;
						for (let y = 0; y < canvas.height; y++) {
							for (let x = 0; x < canvas.width; x++) {
								const index = (y * canvas.width + x) * 4;
								const alpha = pixels[index + 3];
								if (alpha > 0) {
									if (x < minX) minX = x;
									if (x > maxX) maxX = x;
									if (y < minY) minY = y;
									if (y > maxY) maxY = y;
								}
							}
						}
						pureWidth = maxX - minX + 1;
						pureHeight = maxY - minY + 1;
						$('<div>')
							.appendTo(dd)
							.text(`Size: ${pureWidth}x${pureHeight}`)
							.css({
								color: 'blue',
							});
						const MIN_WIDTH = 150;
						const MAX_WIDTH = 300;
						if (
							pureWidth < MIN_WIDTH ||
							pureWidth > MAX_WIDTH ||
							pureHeight < MIN_WIDTH ||
							pureHeight > MAX_WIDTH
						) {
							$('<div>').appendTo(dd).text('Invalid size').css({
								color: 'red',
								'font-weight': 'bold',
								'background-color': 'pink',
							});
						} else {
							dd.append(img);
						}
					},
				});
			}
		})();
	</script>
</html>
